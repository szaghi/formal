# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**FORMAL** is a Python CLI tool that converts Fortran API documentation (parsed by [FORD](https://github.com/Fortran-FORD/ford)) into VitePress-ready Markdown pages. It hooks into FORD's pipeline after `correlate()` to extract raw Markdown from doc_lists, bypassing FORD's HTML generation.

## Commands

### Python development

```bash
# Install in editable mode with dev dependencies
pip install -e ".[dev]"

# Run all tests
pytest

# Run only unit tests (skip FORD-dependent integration tests)
pytest -m "not integration"

# Run a single test file
pytest tests/test_generator.py

# Run a single test
pytest tests/test_generator.py::test_name

# Lint
ruff check src/ tests/

# Fix lint issues
ruff check --fix src/ tests/
```

### VitePress docs site (in `docs/`)

```bash
cd docs && npm install
npm run docs:dev      # local dev server
npm run docs:build    # production build
npm run docs:preview  # preview built site
```

### Release

```bash
# Full release pipeline (bump version, build, test, tag, publish, push)
bash scripts/build_publish.sh release X.Y.Z

# Individual steps
bash scripts/build_publish.sh bump X.Y.Z    # update version in pyproject.toml + __init__.py
bash scripts/build_publish.sh build         # python3 -m build
bash scripts/build_publish.sh publish       # twine upload to PyPI
```

## Architecture

```
src/formal/
├── cli.py          # Argument parsing; dispatches to generator.py or scaffold.py
├── generator.py    # Core engine: FORD → Markdown conversion + sidebar JSON
├── scaffold.py     # VitePress site scaffolding and FORD project file generation
└── __main__.py     # Entry point for `python -m formal`
```

### Data flow

1. **`formal init`** (`cli.py` → `scaffold.py`): Creates FORD project `.md` config file and scaffolds a VitePress site (`package.json`, `config.mts`, landing `index.md`).

2. **`formal generate`** (`cli.py` → `generator.py`):
   - `load_project()` calls FORD's `load_markdown_settings()` + `Project()` to parse Fortran source
   - Each module is formatted to a Markdown file via `format_module()`
   - A `_sidebar.json` is generated by `generate_sidebar()` grouping modules by source directory pattern
   - An `index.md` listing all modules is written

### Key design details

- **FORD integration**: FORD runs fully (including `correlate()`) but FORMAL extracts raw text from `doc_list` fields and bypasses FORD's HTML/Jinja2 rendering.
- **Mocks for unit tests**: `tests/mocks.py` provides duck-typed mock objects (MockVariable, MockType, etc.) so unit tests don't require FORD or a real Fortran project.
- **Integration tests**: Marked `@pytest.mark.integration` and use the real FORD pipeline with `tests/fixtures/sample_module.F90`.
- **Sidebar classification**: `_classify_module()` in `generator.py` recognizes patterns like `src/lib/<name>` → "Library / name" and `src/app/<name>` → "Applications / NAME".
- **Safe scaffolding**: `init_vitepress_site()` never overwrites existing files.
- **Version management**: Version string lives in both `pyproject.toml` and `src/formal/__init__.py`; the release script updates both.
